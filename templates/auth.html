<!DOCTYPE html>
<html lang="en">
    <head>
        <meta charset="UTF-8"><meta name="viewport" content="width=device-width, minimum-scale=1.0">
        <meta name="Description" content="Welcome to Pokémon Stay!">
        <title>Pokémon Stay</title>
        <link href="/static/main.css" rel="stylesheet">
    </head>
    <body>
        <header>
            <h1>Pokémon Stay</h1>
        </header>
        <main>
            <auth>
                <button id="toggle-signin">Sign in</button>
                <button id="toggle-register">Register</button>
                <auth-form>
                    <label for="in-email">Email</label>
                    <input id="in-email" type="email" placeholder="foo@example.com">
                    <label for="in-uname" class="togglable-display hide-register">Username</label>
                    <input id="in-uname" class="togglable-display hide-register" type="text">
                    <label for="in-pass">Password</label>
                    <input id="in-pass" type="password">
                    <label for="in-verify" class="togglable-display hide-register">Verify Password</label>
                    <input id="in-verify" class="togglable-display hide-register" type="password">
                    <button id="btn-submit">Submit</button>
                    <span class="message"></span>
                </auth-form>
            </auth>
        </main>
        <script type="text/javascript">
            let isRegister = false
            let toggleSignIn = document.querySelector("#toggle-signin")
            let toggleRegister = document.querySelector("#toggle-register")
            let btnSubmit = document.querySelector("#btn-submit")
            let message = document.querySelector(".message")

            toggleSignIn.addEventListener('click', e => {
                isRegister = false
                message.textContent = ""
                let togglableDisplays = document.querySelectorAll(".togglable-display")
                for (let disp of togglableDisplays)
                    if (!disp.classList.contains("hide-register"))
                        disp.classList.add("hide-register")
            })
            toggleRegister.addEventListener('click', e => {
                isRegister = true
                message.textContent = ""
                let togglableDisplays = document.querySelectorAll(".togglable-display")
                for (let disp of togglableDisplays)
                    if (disp.classList.contains("hide-register"))
                        disp.classList.remove("hide-register")
            })
            btnSubmit.addEventListener('click', e => {
                if (isRegister)
                    submitRegister(e)
                else
                    submitSignIn(e)
            })
            let submitRegister = e => {
                let email = document.querySelector("#in-email").value
                let uname = document.querySelector("#in-uname").value
                let pass = document.querySelector("#in-pass").value
                let verify = document.querySelector("#in-verify").value
                // TODO: Validate all fields. Especially password against verify.
                var req = new XMLHttpRequest()
                req.responseType = 'json'
                req.addEventListener('load', ev => {
                    if (ev.target.status != 200) {
                        message.textContent = ev.target.response.err
                    } else {
                        message.textContent = "Account creation was successful"
                    }
                })
                req.open('POST', '/auth/create-account')
                req.setRequestHeader("Content-Type", "application/json;charset=UTF-8")
                req.send(JSON.stringify({'email': email, 'username': uname, 'password': pass}))
            }
            let submitSignIn = e => {
                let email = document.querySelector("#in-email").value
                let pass = document.querySelector("#in-pass").value
                // TODO: Validate all fields
                var req = new XMLHttpRequest()
                req.responseType = 'json'
                req.addEventListener('load', ev => {
                    if (ev.target.status != 200) {
                        message.textContent = ev.target.response.err
                    } else {
                        message.textContent = "Account creation was successful"
                    }
                })
                req.open('POST', '/auth/login')
                req.setRequestHeader("Content-Type", "application/json;charset=UTF-8")
                req.send(JSON.stringify({'email':email, 'password': pass}))
            }
        </script>
    </body>
</html>